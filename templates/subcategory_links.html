{% extends "base.html" %}
{% block title %}{{ subcategory.name }} - Links{% endblock %}
{% block content %}
<div class="page-header animate-fade-in">
  <div class="breadcrumb">
    <a href="{{ url_for('dashboard') }}">Dashboard</a>
    <span class="separator">‚Ä∫</span>
    <a href="{{ url_for('category_subcategories', category_id=subcategory.categories.id) }}">{{ subcategory.categories.name }}</a>
    <span class="separator">‚Ä∫</span>
    <span>{{ subcategory.name }}</span>
  </div>
  <h2>{{ subcategory.name }} <span class="gradient-text">Links</span></h2>
  {% if subcategory.description %}
    <p class="text-large">{{ subcategory.description }}</p>
  {% endif %}
</div>

<section class="card card-premium animate-slide-in">
  <h3>Add New Link</h3>
  <form method="post" action="{{ url_for('add_link_to_subcategory', subcategory_id=subcategory.id) }}" class="link-form" id="subcategory-add-form">
    <div class="form-group-with-button">
      <label>
        URL
        <input name="url" id="subcategory-url" placeholder="https://example.com" required>
      </label>
      <button type="button" class="btn btn-outline btn-detect" onclick="detectLinkInfo('subcategory')">
        <span class="detect-text">Select</span>
        <span class="detect-loading" style="display: none;">üì°</span>
      </button>
    </div>
    <div class="form-group">
      <label>
        Link Title
        <input name="title" id="subcategory-title" placeholder="e.g. Shop Now, View Collection, Documentation" required>
      </label>
    </div>
    <div class="form-group">
      <label>
        Description (Optional)
        <textarea name="description" id="subcategory-description" placeholder="Brief description of this link"></textarea>
      </label>
    </div>
    <input type="hidden" name="image_url" id="subcategory-image-url">
    <div class="detected-image" id="subcategory-detected-image" style="display: none;">
      <img src="" alt="Detected image" class="preview-image">
      <span class="image-label">Auto-detected image</span>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" type="submit">Add Link</button>
      <a href="{{ url_for('category_subcategories', category_id=subcategory.categories.id) }}" class="btn btn-outline">Back to Subcategories</a>
    </div>
  </form>
</section>

<section class="card card-glass animate-slide-in">
  <h3>Links in {{ subcategory.name }}</h3>
  {% if links %}
    <div class="links-list stagger-animation">
      {% for link in links %}
      <div class="link-card hover-glow animate-fade-in">
        {% if link.image_url %}
          <div class="link-image">
            <img src="{{ link.image_url }}" alt="{{ link.title }}" class="link-thumbnail">
          </div>
        {% endif %}
        <div class="link-main">
          <div class="link-info">
            <h4>{{ link.title }}</h4>
            {% if link.description %}
              <p class="link-description">{{ link.description }}</p>
            {% endif %}
            <a href="{{ link.url }}" target="_blank" class="link-url" rel="noopener noreferrer">
              {{ link.url }}
              <span class="external-icon">‚Üó</span>
            </a>
          </div>
          <div class="link-stats">
            <span class="click-count">{{ link.click_count or 0 }} clicks</span>
          </div>
        </div>
        <div class="link-actions">
          <a href="{{ url_for('edit_link', link_id=link.id) }}" class="edit-btn" title="Edit Link">‚úèÔ∏è</a>
          <form method="post" action="{{ url_for('delete_link', link_id=link.id) }}" class="delete-form" onsubmit="return confirm('Delete {{ link.title }}?')">
            <button class="delete-btn" type="submit" title="Delete Link">üóëÔ∏è</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-icon">üîó</div>
      <h4>No links yet</h4>
      <p>Add your first link to {{ subcategory.name }} using the form above.</p>
    </div>
  {% endif %}
</section>

<style>
.links-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-4);
  margin-top: var(--space-6);
}

.link-card {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-6);
  background: var(--bg-primary);
  border-radius: var(--radius-xl);
  border: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
}

.link-image {
  flex-shrink: 0;
}

.link-thumbnail {
  width: 64px;
  height: 64px;
  border-radius: var(--radius-md);
  object-fit: cover;
  border: 1px solid var(--border-light);
}

.link-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
  transform: scaleX(0);
  transform-origin: left;
  transition: transform var(--transition-base);
}

.link-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-lg), 0 0 30px rgba(99, 102, 241, 0.15);
  border-color: var(--border-glow);
}

.link-card:hover::before {
  transform: scaleX(1);
}

.link-main {
  display: flex;
  align-items: center;
  gap: var(--space-6);
  flex: 1;
}

.link-info h4 {
  margin: 0 0 var(--space-2) 0;
  color: var(--text-primary);
  font-size: var(--font-size-lg);
}

.link-description {
  margin: 0 0 var(--space-3) 0;
  color: var(--text-muted);
  font-size: var(--font-size-sm);
  line-height: 1.5;
}

.link-url {
  color: var(--primary-solid);
  text-decoration: none;
  font-size: var(--font-size-sm);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: var(--space-2);
  transition: all var(--transition-base);
}

.link-url:hover {
  color: var(--accent-purple);
  transform: translateX(2px);
}

.external-icon {
  font-size: var(--font-size-xs);
  opacity: 0.7;
  transition: all var(--transition-base);
}

.link-url:hover .external-icon {
  opacity: 1;
  transform: translateX(2px) translateY(-2px);
}

.link-stats {
  display: flex;
  align-items: center;
  gap: var(--space-4);
}

.click-count {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1));
  color: var(--accent-emerald);
  font-size: var(--font-size-xs);
  font-weight: 600;
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-full);
  border: 1px solid rgba(16, 185, 129, 0.2);
  white-space: nowrap;
}

.link-actions {
  display: flex;
  gap: var(--space-2);
  margin-left: var(--space-4);
}

.empty-state {
  text-align: center;
  padding: var(--space-16);
  color: var(--text-muted);
}

.empty-icon {
  font-size: var(--font-size-6xl);
  margin-bottom: var(--space-4);
  opacity: 0.6;
}

.empty-state h4 {
  color: var(--text-secondary);
  margin-bottom: var(--space-2);
}

@media (max-width: 768px) {
  .link-main {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-3);
  }
  
  .link-stats {
    align-self: stretch;
    justify-content: flex-start;
  }
  
  .link-actions {
    margin-left: 0;
    margin-top: var(--space-3);
  }
}

/* Auto-detection styles */
.form-group-with-button {
  position: relative;
  display: flex;
  gap: var(--space-2);
  align-items: end;
}

.form-group-with-button label {
  flex: 1;
}

.btn-detect {
  min-width: 80px;
  height: 48px;
  margin-bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-1);
  font-size: var(--font-size-sm);
  border-radius: var(--radius-md);
  transition: all var(--transition-base);
}

.btn-detect:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

.btn-detect.loading {
  pointer-events: none;
  opacity: 0.7;
}

.detected-image {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-light);
  margin: var(--space-3) 0;
}

.preview-image {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-sm);
  object-fit: cover;
  border: 1px solid var(--border-light);
}

.image-label {
  font-size: var(--font-size-sm);
  color: var(--text-muted);
}
</style>

<script>
async function detectLinkInfo(formType) {
  const urlInput = document.getElementById(`${formType}-url`);
  const titleInput = document.getElementById(`${formType}-title`);
  const descriptionInput = document.getElementById(`${formType}-description`);
  const imageUrlInput = document.getElementById(`${formType}-image-url`);
  const detectedImageDiv = document.getElementById(`${formType}-detected-image`);
  const detectBtn = document.querySelector(`#${formType}-add-form .btn-detect`);
  
  const url = urlInput.value.trim();
  if (!url) {
    alert('Please enter a URL first');
    urlInput.focus();
    return;
  }
  
  // Show loading state
  detectBtn.classList.add('loading');
  detectBtn.querySelector('.detect-text').style.display = 'none';
  detectBtn.querySelector('.detect-loading').style.display = 'inline';
  
  try {
    const response = await fetch('/api/detect-link-info', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ url: url })
    });
    
    const data = await response.json();
    
    if (data.error) {
      alert(`Error: ${data.error}`);
      return;
    }
    
    // Populate the form fields
    if (data.title && !titleInput.value) {
      titleInput.value = data.title;
    }
    
    // Set image URL if detected
    if (data.image_url) {
      imageUrlInput.value = data.image_url;
      detectedImageDiv.querySelector('img').src = data.image_url;
      detectedImageDiv.style.display = 'flex';
    }
    
    // Add success visual feedback
    detectBtn.style.background = 'var(--success-solid)';
    detectBtn.querySelector('.detect-text').textContent = '‚úì';
    setTimeout(() => {
      detectBtn.style.background = '';
      detectBtn.querySelector('.detect-text').textContent = 'Select';
    }, 2000);
    
  } catch (error) {
    console.error('Error detecting link info:', error);
    alert('Failed to detect link information. Please try again.');
  } finally {
    // Reset loading state
    detectBtn.classList.remove('loading');
    detectBtn.querySelector('.detect-text').style.display = 'inline';
    detectBtn.querySelector('.detect-loading').style.display = 'none';
  }
}
</script>
{% endblock %}