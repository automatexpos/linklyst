{% extends "base.html" %}
{% block title %}{{ category.name }} - Subcategories{% endblock %}
{% block content %}
<div class="page-header animate-fade-in">
  <div class="breadcrumb">
    <a href="{{ url_for('dashboard') }}">Dashboard</a>
    <span class="separator">‚Ä∫</span>
    <span>{{ category.name }}</span>
  </div>
  <h2>{{ category.name }} <span class="gradient-text">Management</span></h2>
  {% if category.description %}
    <p class="text-large">{{ category.description }}</p>
  {% endif %}
</div>

<!-- Add Direct Link Section -->
<section class="card card-premium animate-slide-in">
  <div class="form-header-with-toggle">
    <div class="form-header-text">
      <h3>Quick Add Link</h3>
      <p class="text-small">Add a link directly to this category without creating a subcategory</p>
    </div>
    <button class="add-form-toggle-btn" onclick="toggleQuickLinkForm()" id="quickLinkToggleBtn">
      <span class="plus-icon">+</span>
      <span class="btn-text">Add Link</span>
    </button>
  </div>
  
  <!-- Collapsible Form (Initially Hidden) -->
  <div class="collapsible-form-container" id="quickLinkForm" style="display: none;">
    <form method="post" action="{{ url_for('add_link_to_category', category_id=category.id) }}" class="small-form" id="quick-add-form">
      <div class="form-group-with-button">
        <label>
          URL
          <input name="url" id="quick-url" placeholder="https://example.com" required>
        </label>
        <button type="button" class="btn btn-outline btn-detect" onclick="detectLinkInfo('quick')">
          <span class="detect-text">Select</span>
          <span class="detect-loading" style="display: none;">üì°</span>
        </button>
      </div>
      <label>
        Link Title
        <input name="title" id="quick-title" placeholder="e.g. Company Website, Portfolio" required>
      </label>
      <label>
        Description (Optional)
        <input name="description" id="quick-description" placeholder="Brief description">
      </label>
      <input type="hidden" name="image_url" id="quick-image-url">
      <div class="detected-image" id="quick-detected-image" style="display: none;">
        <img src="" alt="Detected image" class="preview-image">
        <span class="image-label">Auto-detected image</span>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Add Direct Link</button>
        <button type="button" class="btn btn-secondary" onclick="toggleQuickLinkForm()">Cancel</button>
      </div>
    </form>
  </div>
</section>

<!-- Direct Links Display -->
{% if direct_links %}
<section class="card card-glass animate-slide-in">
  <h3>Direct Links</h3>
  <div class="links-grid stagger-animation">
    {% for link in direct_links %}
    <div class="link-item hover-glow animate-fade-in">
      {% if link.image_url %}
        <div class="link-image">
          <img src="{{ link.image_url }}" alt="{{ link.title }}" class="link-thumbnail">
        </div>
      {% endif %}
      <div class="link-content">
        <h4>{{ link.title }}</h4>
        {% if link.description %}
          <p class="link-desc">{{ link.description }}</p>
        {% endif %}
        <a href="{{ link.url }}" target="_blank" class="link-url">{{ link.url }}</a>
      </div>
      <div class="link-actions">
        <a href="{{ url_for('edit_link', link_id=link.id) }}" class="edit-btn" title="Edit">‚úèÔ∏è</a>
        <form method="post" action="{{ url_for('delete_link', link_id=link.id) }}" class="delete-form" onsubmit="return confirm('Delete this link?')">
          <button class="delete-btn" type="submit" title="Delete">üóëÔ∏è</button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- Add Subcategory Section -->
<section class="card card-premium animate-slide-in">
  <div class="form-header-with-toggle">
    <div class="form-header-text">
      <h3>Add New Subcategory</h3>
      <p class="text-small">Create organized groups for your links</p>
    </div>
    <button class="add-form-toggle-btn" onclick="toggleSubcategoryForm()" id="subcategoryToggleBtn">
      <span class="plus-icon">+</span>
      <span class="btn-text">Add Subcategory</span>
    </button>
  </div>
  
  <!-- Collapsible Form (Initially Hidden) -->
  <div class="collapsible-form-container" id="subcategoryForm" style="display: none;">
    <form method="post" action="{{ url_for('add_subcategory', category_id=category.id) }}" class="subcategory-form" enctype="multipart/form-data">
      <div class="form-row">
        <div class="form-group">
          <label>
            Subcategory Name
            <input name="name" placeholder="e.g. Fashion Brands, Tech Tools, Resources" required>
          </label>
        </div>
        <div class="form-group">
          <label>
            Color
            <input name="color" type="color" value="#6366f1">
          </label>
        </div>
      </div>
      <div class="form-group">
        <label>
          Description
          <textarea name="description" placeholder="Brief description of this subcategory"></textarea>
        </label>
      </div>
      <div class="form-group">
        <label>
          Subcategory Icon
          <input type="file" name="icon_file" accept="image/*" class="file-input">
          <div class="file-input-helper">
            <span class="file-btn">Choose Icon</span>
            <span class="file-text">Upload custom icon (optional)</span>
          </div>
        </label>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Create Subcategory</button>
        <button type="button" class="btn btn-secondary" onclick="toggleSubcategoryForm()">Cancel</button>
      </div>
    </form>
  </div>
</section>

<!-- Subcategories Display -->
{% if subcategories %}
<section class="subcategories-section animate-slide-in">
  <h3>Subcategories</h3>
  <div class="subcategories-grid stagger-animation">
    {% for subcategory in subcategories %}
    <div class="subcategory-card hover-glow animate-fade-in energy-pulse">
      <div class="subcategory-content" onclick="window.location.href='{{ url_for('subcategory_links', subcategory_id=subcategory.id) }}'">
        {% if subcategory.icon_url %}
          <div class="subcategory-icon">
            <img src="{{ subcategory.icon_url }}" alt="{{ subcategory.name }} icon">
          </div>
        {% else %}
          <div class="subcategory-icon default-icon" style="background: {{ subcategory.color }};">
            üìÅ
          </div>
        {% endif %}
        <h4 class="gradient-text">{{ subcategory.name }}</h4>
        {% if subcategory.description %}
          <p class="subcategory-desc">{{ subcategory.description }}</p>
        {% endif %}
        <div class="link-count">
          {{ subcategory.link_count }} link{{ 's' if subcategory.link_count != 1 else '' }}
        </div>
      </div>
      <div class="subcategory-actions">
        <a href="{{ url_for('edit_subcategory', subcategory_id=subcategory.id) }}" class="edit-btn" title="Edit">‚úèÔ∏è</a>
        <form method="post" action="{{ url_for('delete_subcategory', subcategory_id=subcategory.id) }}" class="delete-form" onsubmit="return confirm('Delete {{ subcategory.name }}? This will also delete all links in it.')">
          <button class="delete-btn" type="submit" title="Delete">üóëÔ∏è</button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% else %}
  {% if not direct_links %}
  <div class="empty-state animate-fade-in">
    <div class="empty-icon">üìÇ</div>
    <h3>No subcategories yet</h3>
    <p>Create your first subcategory to organize your links, or add links directly to this category.</p>
  </div>
  {% endif %}
{% endif %}

<style>
.form-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: var(--space-4);
  align-items: end;
}

.subcategories-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--space-6);
  margin-top: var(--space-6);
}

.subcategory-card {
  background: var(--bg-card);
  border-radius: var(--radius-xl);
  overflow: hidden;
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-light);
  transition: all var(--transition-base);
  position: relative;
}

.subcategory-card:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: var(--shadow-xl), var(--shadow-glow);
  border-color: var(--border-glow);
}

.subcategory-content {
  padding: var(--space-6);
  cursor: pointer;
  text-align: center;
}

.subcategory-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto var(--space-4);
  border-radius: var(--radius-full);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--font-size-2xl);
  box-shadow: var(--shadow-md);
}

.subcategory-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: var(--radius-full);
}

.default-icon {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
  color: white;
}

.subcategory-desc {
  color: var(--text-muted);
  font-size: var(--font-size-sm);
  margin: var(--space-2) 0;
}

.link-count {
  display: inline-block;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
  color: var(--primary-solid);
  font-size: var(--font-size-xs);
  font-weight: 600;
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-full);
  border: 1px solid rgba(99, 102, 241, 0.2);
  margin-top: var(--space-3);
}

.subcategory-actions {
  display: flex;
  gap: var(--space-2);
  justify-content: center;
  padding: var(--space-4);
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-light);
}

.links-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--space-4);
  margin-top: var(--space-4);
}

.link-item {
  display: flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-4);
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-light);
  transition: all var(--transition-base);
}

.link-image {
  flex-shrink: 0;
}

.link-thumbnail {
  width: 56px;
  height: 56px;
  border-radius: var(--radius-md);
  object-fit: cover;
  border: 1px solid var(--border-light);
}

.link-content {
  flex: 1;
  min-width: 0;
}

.link-content h4 {
  margin: 0 0 var(--space-2) 0;
  color: var(--text-primary);
}

.link-desc {
  margin: 0 0 var(--space-2) 0;
  color: var(--text-muted);
  font-size: var(--font-size-sm);
}

.link-url {
  color: var(--primary-solid);
  font-size: var(--font-size-sm);
  text-decoration: none;
}

.link-actions {
  display: flex;
  gap: var(--space-2);
}

.empty-state {
  text-align: center;
  padding: var(--space-20);
  color: var(--text-muted);
}

.empty-icon {
  font-size: var(--font-size-6xl);
  margin-bottom: var(--space-4);
}

/* Auto-detection styles */
.form-group-with-button {
  position: relative;
  display: flex;
  gap: var(--space-2);
  align-items: end;
}

.form-group-with-button label {
  flex: 1;
}

.btn-detect {
  min-width: 80px;
  height: 48px;
  margin-bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-1);
  font-size: var(--font-size-sm);
  border-radius: var(--radius-md);
  transition: all var(--transition-base);
}

.btn-detect:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

.btn-detect.loading {
  pointer-events: none;
  opacity: 0.7;
}

.detected-image {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  padding: var(--space-3);
  background: var(--bg-secondary);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-light);
  margin: var(--space-3) 0;
}

.preview-image {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-sm);
  object-fit: cover;
  border: 1px solid var(--border-light);
}

.image-label {
  font-size: var(--font-size-sm);
  color: var(--text-muted);
}
</style>

<script>
async function detectLinkInfo(formType) {
  const urlInput = document.getElementById(`${formType}-url`);
  const titleInput = document.getElementById(`${formType}-title`);
  const descriptionInput = document.getElementById(`${formType}-description`);
  const imageUrlInput = document.getElementById(`${formType}-image-url`);
  const detectedImageDiv = document.getElementById(`${formType}-detected-image`);
  const detectBtn = document.querySelector(`#${formType}-add-form .btn-detect`);
  
  const url = urlInput.value.trim();
  if (!url) {
    alert('Please enter a URL first');
    urlInput.focus();
    return;
  }
  
  // Show loading state
  detectBtn.classList.add('loading');
  detectBtn.querySelector('.detect-text').style.display = 'none';
  detectBtn.querySelector('.detect-loading').style.display = 'inline';
  
  try {
    const response = await fetch('/api/detect-link-info', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ url: url })
    });
    
    const data = await response.json();
    
    if (data.error) {
      alert(`Error: ${data.error}`);
      return;
    }
    
    // Populate the form fields
    if (data.title && !titleInput.value) {
      titleInput.value = data.title;
    }
    
    // Set image URL if detected
    if (data.image_url) {
      imageUrlInput.value = data.image_url;
      detectedImageDiv.querySelector('img').src = data.image_url;
      detectedImageDiv.style.display = 'flex';
    }
    
    // Add success visual feedback
    detectBtn.style.background = 'var(--success-solid)';
    detectBtn.querySelector('.detect-text').textContent = '‚úì';
    setTimeout(() => {
      detectBtn.style.background = '';
      detectBtn.querySelector('.detect-text').textContent = 'Select';
    }, 2000);
    
  } catch (error) {
    console.error('Error detecting link info:', error);
    alert('Failed to detect link information. Please try again.');
  } finally {
    // Reset loading state
    detectBtn.classList.remove('loading');
    detectBtn.querySelector('.detect-text').style.display = 'inline';
    detectBtn.querySelector('.detect-loading').style.display = 'none';
  }
}

// Collapsible form functionality
function toggleQuickLinkForm() {
  const form = document.getElementById('quickLinkForm');
  const toggleBtn = document.getElementById('quickLinkToggleBtn');
  const plusIcon = toggleBtn.querySelector('.plus-icon');
  const btnText = toggleBtn.querySelector('.btn-text');
  
  if (form.style.display === 'none' || form.style.display === '') {
    // Show form
    form.style.display = 'block';
    plusIcon.textContent = '√ó';
    btnText.textContent = 'Cancel';
    toggleBtn.classList.add('active');
    
    // Focus on the first input
    setTimeout(() => {
      const firstInput = form.querySelector('input[name="url"]');
      if (firstInput) firstInput.focus();
    }, 100);
  } else {
    // Hide form
    form.style.display = 'none';
    plusIcon.textContent = '+';
    btnText.textContent = 'Add Link';
    toggleBtn.classList.remove('active');
    
    // Clear form
    const formElement = form.querySelector('form');
    if (formElement) formElement.reset();
    
    // Clear detected image
    const detectedImage = document.getElementById('quick-detected-image');
    if (detectedImage) detectedImage.style.display = 'none';
    document.getElementById('quick-image-url').value = '';
  }
}

function toggleSubcategoryForm() {
  const form = document.getElementById('subcategoryForm');
  const toggleBtn = document.getElementById('subcategoryToggleBtn');
  const plusIcon = toggleBtn.querySelector('.plus-icon');
  const btnText = toggleBtn.querySelector('.btn-text');
  
  if (form.style.display === 'none' || form.style.display === '') {
    // Show form
    form.style.display = 'block';
    plusIcon.textContent = '√ó';
    btnText.textContent = 'Cancel';
    toggleBtn.classList.add('active');
    
    // Focus on the first input
    setTimeout(() => {
      const firstInput = form.querySelector('input[name="name"]');
      if (firstInput) firstInput.focus();
    }, 100);
  } else {
    // Hide form
    form.style.display = 'none';
    plusIcon.textContent = '+';
    btnText.textContent = 'Add Subcategory';
    toggleBtn.classList.remove('active');
    
    // Clear form
    const formElement = form.querySelector('form');
    if (formElement) formElement.reset();
  }
}

// Initialize form states and handle successful submission
document.addEventListener('DOMContentLoaded', function() {
  const quickLinkForm = document.getElementById('quickLinkForm');
  const subcategoryForm = document.getElementById('subcategoryForm');
  const quickLinkToggle = document.getElementById('quickLinkToggleBtn');
  const subcategoryToggle = document.getElementById('subcategoryToggleBtn');
  
  // Force initial states - forms hidden
  if (quickLinkForm && quickLinkToggle) {
    quickLinkForm.style.display = 'none';
    quickLinkToggle.querySelector('.plus-icon').textContent = '+';
    quickLinkToggle.querySelector('.btn-text').textContent = 'Add Link';
    quickLinkToggle.classList.remove('active');
  }
  
  if (subcategoryForm && subcategoryToggle) {
    subcategoryForm.style.display = 'none';
    subcategoryToggle.querySelector('.plus-icon').textContent = '+';
    subcategoryToggle.querySelector('.btn-text').textContent = 'Add Subcategory';
    subcategoryToggle.classList.remove('active');
  }
  
  // Check for error messages - if there are errors, show the appropriate form
  const errorMessages = document.querySelectorAll('.alert.alert-danger, .flash-message.danger, .flash-message.error');
  if (errorMessages.length > 0) {
    // Try to determine which form had errors based on the current URL or form fields
    // For now, show the subcategory form if there are errors
    // You could make this more sophisticated by checking error content
    if (subcategoryForm && subcategoryToggle) {
      subcategoryForm.style.display = 'block';
      subcategoryToggle.querySelector('.plus-icon').textContent = '√ó';
      subcategoryToggle.querySelector('.btn-text').textContent = 'Cancel';
      subcategoryToggle.classList.add('active');
    }
  }
});
</script>

<style>
/* Collapsible Form Styles */
.form-header-with-toggle {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 1rem;
}

.form-header-text {
  flex: 1;
}

.form-header-text h3 {
  margin: 0 0 0.5rem 0;
}

.form-header-text p {
  margin: 0;
}

.add-form-toggle-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: var(--primary);
  color: white;
  border: none;
  padding: 0.75rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  font-size: 0.9rem;
  white-space: nowrap;
  flex-shrink: 0;
}

.add-form-toggle-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.add-form-toggle-btn.active {
  background: #dc3545;
}

.add-form-toggle-btn.active:hover {
  background: #c82333;
}

.plus-icon {
  font-size: 1.2rem;
  font-weight: bold;
  transition: transform 0.2s ease;
}

.add-form-toggle-btn.active .plus-icon {
  transform: rotate(45deg);
}

.collapsible-form-container {
  overflow: hidden;
  transition: all 0.3s ease;
}

.collapsible-form-container form {
  animation: slideDown 0.3s ease;
  border: 1px solid var(--border-light);
  border-radius: 6px;
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  margin-top: 1rem;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.btn-secondary {
  background: transparent;
  color: #dc3545;
  border: 1px solid #dc3545;
}

.btn-secondary:hover {
  background: #dc3545;
  color: white;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .form-header-with-toggle {
    flex-direction: column;
    align-items: stretch;
  }
  
  .add-form-toggle-btn {
    align-self: flex-start;
  }
}
</style>
{% endblock %}