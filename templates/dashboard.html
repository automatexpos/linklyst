{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="dashboard-content">
<h2>Dashboard</h2>

<!-- Always Visible: Analytics and Share Profile -->
<div class="form-section">
  <section class="card">
    <h3>Analytics Overview</h3>
    <div class="analytics-grid">
      <div class="stat-card">
        <h4>Total Links</h4>
        <span class="stat-number">{{ analytics.total_links }}</span>
      </div>
      <div class="stat-card">
        <h4>Total Clicks</h4>
        <span class="stat-number">{{ analytics.total_clicks }}</span>
      </div>
      <div class="stat-card">
        <h4>Categories</h4>
        <span class="stat-number">{{ analytics.categories_count }}</span>
      </div>
      <div class="stat-card">
        <h4>Brands</h4>
        <span class="stat-number">{{ analytics.brands_count }}</span>
      </div>
    </div>
    
    {% if analytics.trending_links %}
      <div class="top-links-section">
        <h4>Trending Links</h4>
        <div class="top-links-list">
          {% for link in analytics.trending_links %}
            <div class="top-link-item">
              <div class="link-info">
                <strong>{{ link.title }}</strong>
                <small>{{ link.url }}</small>
              </div>
              <div class="link-clicks">
                <span class="click-count">{{ link.clicks }}</span>
                <small>clicks</small>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </section>
</div>

<div class="form-section">
  <section class="card">
    <h3>Share Your Profile</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
      Share this link to let people access all your links in one place:
    </p>
    <a href="{{ site_base }}{{ url_for('public_profile', username=user.username) }}" 
       target="_blank" 
       class="public-link">
      {{ site_base }}{{ url_for('public_profile', username=user.username) }}
    </a>
  </section>
</div>
</div>

<!-- Modal Overlays -->
<!-- Profile Settings Modal -->
<div id="profile-modal" class="modal-overlay" style="display: none;">
  <div class="modal-backdrop" onclick="closeModal('profile-modal')"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Profile Settings</h3>
      <button class="modal-close" onclick="closeModal('profile-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <form method="post" action="{{ url_for('edit_profile') }}" enctype="multipart/form-data">
        <label>
          Display Name
          <input name="display_name" value="{{ profile.display_name or '' }}" placeholder="Your display name">
        </label>
        <label>
          Bio
          <textarea name="bio" placeholder="Tell people about yourself">{{ profile.bio or '' }}</textarea>
        </label>
        
        <div class="avatar-section">
          <label>Current Avatar</label>
          {% if profile.avatar_url %}
            <div class="current-avatar">
              <img src="{{ profile.avatar_url }}" alt="Current Avatar" class="avatar-preview">
            </div>
          {% else %}
            <div class="current-avatar">
              <div class="no-avatar">No avatar set</div>
            </div>
          {% endif %}
          
          <label>
            Upload New Avatar
            <input type="file" name="avatar_file" accept="image/*" class="file-input">
            <div class="file-input-helper">
              <span class="file-btn">Choose Image</span>
              <span class="file-text">Or drag and drop an image</span>
            </div>
          </label>
          
          <details class="avatar-url-option">
            <summary>Or use a URL instead</summary>
            <label>
              Avatar URL
              <input name="avatar_url" value="{{ profile.avatar_url or '' }}" placeholder="https://example.com/avatar.jpg">
            </label>
          </details>
        </div>
        <label>
          Theme
          <select name="theme">
            <option value="default" {% if profile.theme=='default' or not profile.theme %}selected{% endif %}>Default</option>
            <option value="dark" {% if profile.theme=='dark' %}selected{% endif %}>Dark</option>
            <option value="light" {% if profile.theme=='light' %}selected{% endif %}>Light</option>
            <option value="colorful" {% if profile.theme=='colorful' %}selected{% endif %}>Colorful</option>
          </select>
        </label>
        <div class="form-actions">
          <button class="btn" type="submit">Save Profile</button>
          <button 
            type="button" 
            class="btn btn-secondary" 
            style="color: red;" 
            onclick="closeModal('profile-modal')">
            Cancel
          </button>

        </div>
      </form>
    </div>
  </div>
</div>

<!-- Categories Modal -->
<div id="categories-modal" class="modal-overlay" style="display: none;">
  <div class="modal-backdrop" onclick="closeModal('categories-modal')"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Categories</h3>
      <button class="modal-close" onclick="closeModal('categories-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <section class="card">
        <form method="post" action="{{ url_for('add_category') }}" class="category-form" enctype="multipart/form-data">
          <label>
            Category Name
            <input name="name" placeholder="e.g. Bags, Shoes, Watches" required>
          </label>
          <label>
            Description
            <input name="description" placeholder="Brief description (optional)">
          </label>
          <label>
            Color
            <input name="color" type="color" value="#6366f1">
          </label>
          <label>
            Category Icon
            <input type="file" name="icon_file" accept="image/*" class="file-input">
            <div class="file-input-helper">
              <span class="file-btn">Choose Icon</span>
              <span class="file-text">Upload custom icon (optional)</span>
            </div>
          </label>
          <button class="btn" type="submit">Add Category</button>
        </form>

        {% if categories %}
          <div class="category-grid">
            {% for category in categories %}
              <div class="category-card" style="border-left: 4px solid {{ category.color }}">
                <div class="category-content" onclick="window.location.href='{{ url_for('category_brands', category_id=category.id) }}'">
                  <div class="category-header">
                    <h4>{{ category.name }}</h4>
                    <span class="brand-count">{{ category.brand_count or 0 }} brands</span>
                  </div>
                  {% if category.description %}
                    <p class="category-description">{{ category.description }}</p>
                  {% endif %}
                </div>
                <div class="category-actions">
                  <a href="{{ url_for('edit_category', category_id=category.id) }}" class="edit-btn" title="Edit Category">‚úèÔ∏è</a>
                  <form method="post" action="{{ url_for('delete_category', category_id=category.id) }}" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this category? This will also delete all associated brands and links.')">
                    <button type="submit" class="delete-btn" title="Delete Category">üóëÔ∏è</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>No categories created yet. Add your first category above.</p>
          </div>
        {% endif %}
      </section>
    </div>
  </div>
</div>

  <!-- Brands Section (Commented Out) -->
  <!-- 
  <div class="collapsible-section">
    <button class="section-toggle" onclick="toggleSection('brands-section')">
      <span class="toggle-icon">‚ñ∂</span>
      <h3>Brands</h3>
    </button>
    <div id="brands-section" class="section-content" style="display: none;">
      <section class="card">
        <h4>Brands Overview</h4>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
          Brands are organized within categories. Click on a category above, then manage brands within that category.
        </p>
        {% if categories %}
          <div class="category-quick-links">
            {% for category in categories %}
              <a href="{{ url_for('category_brands', category_id=category.id) }}" class="quick-link-btn" style="border-color: {{ category.color }}">
                <span style="color: {{ category.color }}">‚óè</span>
                {{ category.name }}
                <small>({{ category.brand_count or 0 }} brands)</small>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>Create categories first to organize your brands.</p>
          </div>
        {% endif %}
      </section>
    </div>
  </div>

  <!-- Links Section (Commented Out) -->
  <!--
  <div class="collapsible-section">
    <button class="section-toggle" onclick="toggleSection('links-section')">
      <span class="toggle-icon">‚ñ∂</span>
      <h3>Links</h3>
    </button>
    <div id="links-section" class="section-content" style="display: none;">
      <section class="card">
        <h4>Links Overview</h4>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
          Links are organized within brands. Navigate to a category, then to a brand to manage links.
        </p>
        {% if categories %}
          <div class="category-quick-links">
            {% for category in categories %}
              <a href="{{ url_for('category_brands', category_id=category.id) }}" class="quick-link-btn" style="border-color: {{ category.color }}">
                <span style="color: {{ category.color }}">‚óè</span>
                {{ category.name }}
                <small>({{ category.brand_count or 0 }} brands)</small>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p>Create categories and brands first to organize your links.</p>
          </div>
        {% endif %}
      </section>
    </div>
  </div>
  -->
</div>

<script>
function toggleSection(sectionId) {
  // Convert section IDs to modal IDs
  let modalId;
  if (sectionId === 'profile-section') {
    modalId = 'profile-modal';
  } else if (sectionId === 'categories-section') {
    modalId = 'categories-modal';
  }
  
  if (modalId) {
    openModal(modalId);
  }
}

function openModal(modalId) {
  const modal = document.getElementById(modalId);
  const dashboardContent = document.querySelector('.dashboard-content');
  
  if (modal && dashboardContent) {
    modal.style.display = 'flex';
    dashboardContent.classList.add('blur-background');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
    
    // Remove active class from all nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Add active class to corresponding nav button
    const buttonText = modalId === 'profile-modal' ? 'Profile Settings' : 'Categories';
    const activeButton = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
      btn.textContent.trim() === buttonText
    );
    if (activeButton) {
      activeButton.classList.add('active');
    }
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  const dashboardContent = document.querySelector('.dashboard-content');
  
  if (modal && dashboardContent) {
    modal.style.display = 'none';
    dashboardContent.classList.remove('blur-background');
    document.body.style.overflow = ''; // Restore scrolling
    
    // Remove active class from all nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
  }
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const openModals = document.querySelectorAll('.modal-overlay[style*="flex"]');
    openModals.forEach(modal => {
      closeModal(modal.id);
    });
  }
});

// Check URL parameters and open modal if specified
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const modalParam = urlParams.get('modal');
  
  if (modalParam === 'profile') {
    openModal('profile-modal');
    // Remove the parameter from URL without reloading
    window.history.replaceState({}, document.title, window.location.pathname);
  } else if (modalParam === 'categories') {
    openModal('categories-modal');
    // Remove the parameter from URL without reloading
    window.history.replaceState({}, document.title, window.location.pathname);
  }
});

// Enhanced delete confirmations
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('delete-btn')) {
    const form = e.target.closest('form');
    const action = form.action;
    
    let confirmMessage = 'Are you sure you want to delete this item?';
    
    if (action.includes('/category/') && action.includes('/delete')) {
      confirmMessage = 'Are you sure you want to delete this category?\n\nThis will permanently delete:\n‚Ä¢ The category\n‚Ä¢ All brands in this category\n‚Ä¢ All links associated with those brands\n\nThis action cannot be undone.';
    } else if (action.includes('/brand/') && action.includes('/delete')) {
      confirmMessage = 'Are you sure you want to delete this brand?\n\nThis will permanently delete:\n‚Ä¢ The brand\n‚Ä¢ All links associated with this brand\n\nThis action cannot be undone.';
    } else if (action.includes('/link/') && action.includes('/delete')) {
      confirmMessage = 'Are you sure you want to delete this link?\n\nThis action cannot be undone.';
    }
    
    if (!confirm(confirmMessage)) {
      e.preventDefault();
      return false;
    }
  }
});
</script>
{% endblock %}