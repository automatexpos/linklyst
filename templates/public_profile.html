{% extends "base.html" %}
{% block title %}{{ profile.display_name or user.username }}{% endblock %}
{% block content %}
  <div class="profile-card {{ profile.theme or 'default' }}">
    {% if profile.avatar_url %}
      <img class="avatar" src="{{ profile.avatar_url }}" alt="{{ profile.display_name or user.username }}'s avatar">
    {% endif %}
    
    <h1>{{ profile.display_name or user.username }}</h1>
    
    {% if profile.bio %}
      <p class="bio">{{ profile.bio }}</p>
    {% endif %}

    <!-- Categories Grid -->
    <div class="public-content">
      {% if categories %}
        <div class="public-categories-grid" id="categoriesGrid">
          {% for category in categories %}
            <div class="public-category-card" 
                 data-category-id="{{ category.id }}" 
                 onclick="toggleCategory({{ category.id }})"
                 style="border-color: {{ category.color }}">
              <div class="public-category-content">
                <div class="category-icon" style="background-color: {{ category.color }}20; color: {{ category.color }}">
                  {% if category.icon_url %}
                    <img src="{{ category.icon_url }}" alt="{{ category.name }} icon" class="custom-icon">
                  {% else %}
                    <i class="icon">üì¶</i>
                  {% endif %}
                </div>
                <h3>{{ category.name }}</h3>
                {% if category.description %}
                  <p class="category-desc">{{ category.description }}</p>
                {% endif %}
                <span class="expand-indicator">+</span>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Category Content Container (Initially Hidden) -->
        <div class="content-container" id="contentContainer" style="display: none;">
          <div class="back-nav">
            <button onclick="showCategories()" class="back-btn">‚Üê Back to Categories</button>
            <h3 id="categoryTitle"></h3>
          </div>
          
          <!-- Direct Links Section -->
          <div class="direct-links-section" id="directLinksSection" style="display: none;">
            <h4>Quick Links</h4>
            <div class="public-links-grid" id="directLinksGrid"></div>
          </div>
          
          <!-- Subcategories Section -->
          <div class="subcategories-section" id="subcategoriesSection" style="display: none;">
            <h4>Subcategories</h4>
            <div class="public-brands-grid" id="subcategoriesGrid"></div>
          </div>
        </div>

        <!-- Links Container (Initially Hidden) -->
        <div class="links-container" id="linksContainer" style="display: none;">
          <div class="back-nav">
            <button onclick="showCategoryContent()" class="back-btn">‚Üê Back to Category</button>
            <h3 id="subcategoryTitle"></h3>
          </div>
          <div class="public-links-grid" id="linksGrid">
            <!-- Links will be loaded dynamically -->
          </div>
        </div>

      {% else %}
        <div class="empty-public-profile">
          <p>No content available yet.</p>
        </div>
      {% endif %}
    </div>

    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-light);">
      <small style="color: var(--text-muted);">Powered by Linklyst</small>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-indicator" id="loadingIndicator" style="display: none;">
    <div class="spinner"></div>
  </div>

<script>
let currentView = 'categories';
let currentCategoryId = null;
let currentSubcategoryId = null;
let currentCategoryName = '';
let currentSubcategoryName = '';

function showCategories() {
  document.getElementById('categoriesGrid').style.display = 'grid';
  document.getElementById('contentContainer').style.display = 'none';
  document.getElementById('linksContainer').style.display = 'none';
  currentView = 'categories';
}

function showCategoryContent() {
  document.getElementById('categoriesGrid').style.display = 'none';
  document.getElementById('contentContainer').style.display = 'block';
  document.getElementById('linksContainer').style.display = 'none';
  currentView = 'content';
}

function showLinks() {
  document.getElementById('categoriesGrid').style.display = 'none';
  document.getElementById('contentContainer').style.display = 'none';
  document.getElementById('linksContainer').style.display = 'block';
  currentView = 'links';
}

function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

async function toggleCategory(categoryId) {
  if (currentView !== 'categories') return;
  
  const categoryCard = document.querySelector(`[data-category-id="${categoryId}"]`);
  currentCategoryName = categoryCard.querySelector('h3').textContent;
  currentCategoryId = categoryId;
  
  showLoading();
  
  try {
    const response = await fetch(`/api/category/${categoryId}/content`);
    const data = await response.json();
    
    if (data.error) {
      alert(data.error);
      return;
    }
    
    displayCategoryContent(data);
    document.getElementById('categoryTitle').textContent = currentCategoryName;
    showCategoryContent();
    
  } catch (error) {
    console.error('Error loading category content:', error);
    alert('Error loading category content');
  } finally {
    hideLoading();
  }
}

async function toggleSubcategory(subcategoryId, subcategoryName) {
  if (currentView !== 'content') return;
  
  currentSubcategoryId = subcategoryId;
  currentSubcategoryName = subcategoryName;
  
  showLoading();
  
  try {
    const response = await fetch(`/api/subcategory/${subcategoryId}/links`);
    const data = await response.json();
    
    if (data.error) {
      alert(data.error);
      return;
    }
    
    if (data.links) {
      displayLinks(data.links);
      document.getElementById('subcategoryTitle').textContent = currentSubcategoryName;
      showLinks();
    }
  } catch (error) {
    console.error('Error loading links:', error);
    alert('Error loading links');
  } finally {
    hideLoading();
  }
}

function displayCategoryContent(data) {
  const { subcategories, direct_links } = data;
  
  // Show/hide direct links section
  const directLinksSection = document.getElementById('directLinksSection');
  if (direct_links && direct_links.length > 0) {
    displayDirectLinks(direct_links);
    directLinksSection.style.display = 'block';
  } else {
    directLinksSection.style.display = 'none';
  }
  
  // Show/hide subcategories section
  const subcategoriesSection = document.getElementById('subcategoriesSection');
  if (subcategories && subcategories.length > 0) {
    displaySubcategories(subcategories);
    subcategoriesSection.style.display = 'block';
  } else {
    subcategoriesSection.style.display = 'none';
  }
  
  // If no content at all, show message
  if ((!direct_links || direct_links.length === 0) && (!subcategories || subcategories.length === 0)) {
    document.getElementById('contentContainer').innerHTML = `
      <div class="back-nav">
        <button onclick="showCategories()" class="back-btn">‚Üê Back to Categories</button>
        <h3>${currentCategoryName}</h3>
      </div>
      <div class="empty-public-profile">
        <p>No content available in this category yet.</p>
      </div>
    `;
  }
}

function displayDirectLinks(links) {
  const directLinksGrid = document.getElementById('directLinksGrid');
  directLinksGrid.innerHTML = '';
  
  links.forEach(link => {
    const linkCard = document.createElement('div');
    linkCard.className = 'public-link-card';
    
    linkCard.innerHTML = `
      <a href="/r/${link.id}" target="_blank" class="public-link-content">
        ${link.image_url ? 
          `<div class="link-icon"><img src="${link.image_url}" alt="${link.title}" class="link-image"></div>` : 
          `<div class="link-icon">üîó</div>`
        }
        <h4>${link.title}</h4>
        ${link.description ? `<p class="link-desc">${link.description}</p>` : ''}
      </a>
    `;
    
    directLinksGrid.appendChild(linkCard);
  });
}

function displaySubcategories(subcategories) {
  const subcategoriesGrid = document.getElementById('subcategoriesGrid');
  subcategoriesGrid.innerHTML = '';
  
  subcategories.forEach(subcategory => {
    const subcategoryCard = document.createElement('div');
    subcategoryCard.className = 'public-brand-card';
    subcategoryCard.onclick = () => toggleSubcategory(subcategory.id, subcategory.name);
    
    subcategoryCard.innerHTML = `
      <div class="public-brand-content">
        <div class="brand-icon" style="background-color: ${subcategory.color}20; color: ${subcategory.color}">
          ${subcategory.icon_url ? `<img src="${subcategory.icon_url}" alt="${subcategory.name} icon" class="custom-icon">` : 'üìÅ'}
        </div>
        <h4>${subcategory.name}</h4>
        ${subcategory.description ? `<p class="brand-desc">${subcategory.description}</p>` : ''}
        <span class="link-count">${subcategory.link_count || 0} links</span>
        <span class="expand-indicator">‚Üí</span>
      </div>
    `;
    
    subcategoriesGrid.appendChild(subcategoryCard);
  });
}

function displayLinks(links) {
  const linksGrid = document.getElementById('linksGrid');
  linksGrid.innerHTML = '';
  
  links.forEach(link => {
    const linkCard = document.createElement('div');
    linkCard.className = 'public-link-card';
    
    linkCard.innerHTML = `
      <a href="/r/${link.id}" target="_blank" class="public-link-content">
        ${link.image_url ? 
          `<div class="link-icon"><img src="${link.image_url}" alt="${link.title}" class="link-image"></div>` : 
          `<div class="link-icon">üîó</div>`
        }
        <h4>${link.title}</h4>
        ${link.description ? `<p class="link-desc">${link.description}</p>` : ''}
      </a>
    `;
    
    linksGrid.appendChild(linkCard);
  });
}
</script>
{% endblock %}